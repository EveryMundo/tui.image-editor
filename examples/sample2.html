<canvas id="a" width="300" height="300"></canvas>
<canvas id="c" width="300" height="300"></canvas>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.0/fabric.js"></script>
<script>
var bg = window._canvas = new fabric.Canvas('a');
var canvas = window._canvas = new fabric.Canvas('c');

var clipPath = new fabric.Circle({
  radius: 40,
  top: -40,
  left: -40,
  stroke: '#000000',
  strokeWidth: 1,
});

function rotatedRect(x, y, halfWidth, halfHeight, angle) {
    let c = Math.cos(angle);
    let s = Math.sin(angle);
    let r1x = -halfWidth * c - halfHeight * s;
    let r1y = -halfWidth * s + halfHeight * c;
    let r2x =  halfWidth * c - halfHeight * s;
    let r2y =  halfWidth * s + halfHeight * c;

    return [
        [x + r1x, y + r1y],
        [x + r2x, y + r2y],
        [x - r1x, y - r1y],
        [x - r2x, y - r2y]
    ];
}


function adjustOriginPosition(text, editStatus) {
    let [originX, originY] = ['center', 'center'];
    if (editStatus === 'start') {
        [originX, originY] = ['left', 'top'];
    }

    const {x: left, y: top} = text.getPointByOrigin(originX, originY);
    text.set({
        left,
        top,
        originX,
        originY
    });
    text.setCoords();
}


fabric.Image.fromURL("http://localhost:8080/examples/img/bg.jpg", function (img) {
    bg.setBackgroundImage(img);
    bg.renderAll();

    const copiedCanvas = bg.toCanvasElement();
    let blurredImage = new fabric.Image(copiedCanvas);

    const {x: left, y: top} = blurredImage.getPointByOrigin('center', 'center');


    let patternSourceCanvas = new fabric.StaticCanvas();
    const filter = new fabric.Image.filters.Pixelate({
        blocksize: 7
    });
    blurredImage.filters.push(filter);
    blurredImage.applyFilters();

    patternSourceCanvas.add(blurredImage);
    patternSourceCanvas.renderAll();
    // blurredImage.clipPath = clipPath;

    const instance = new fabric.Rect({
        type: 'rect',
        left: 150,
        top: 150,
        stroke: '#000000',
        strokeWidth: 1,
        originX: 'center',
        originY: 'center',
        fill: new fabric.Pattern({
            source: function() {
              patternSourceCanvas.setDimensions({
                width: blurredImage.getScaledWidth(),
                height: blurredImage.getScaledHeight()
              });
              patternSourceCanvas.renderAll();

              return patternSourceCanvas.getElement();
            },
            repeat: 'no-repeat'
        }),
        objectCaching: false,
        width: 200,
        height: 200 
    });

    blurredImage.set({
      originX: 'left',
      originY: 'top',
      left: 0,
      top: 0,
      width: instance.width,
      height: instance.height,
      cropX: instance.left - (instance.width / 2),
      cropY: instance.top - (instance.height / 2),
    });

    const instance2 = new fabric.Rect({
      width: 100,
      height: 100,
      stroke: '#000',
      strokeWidth: 1,
      objectCaching: false,
    });

    bg.add(instance2);
    bg.add(instance);

    instance.on('rotating', (aa) => {
      adjustOriginPosition(blurredImage, 'end'); //center, center
      blurredImage.set('angle', instance.angle * -1);

      adjustOriginPosition(blurredImage, 'start'); //left, top

      const aas = rotatedRect(instance.left, instance.top, instance.width / 2, instance.height / 2, instance.angle);
      console.log(aas);

    });

    instance.on('scaling', (aa) => {
      console.log('scaled', instance.scaleX);
      instance.width *= instance.scaleX;
      instance.height *= instance.scaleY;

      instance.scaleX = 1;
      instance.scaleY = 1;

      console.log(instance.left - (300 / 2));

      blurredImage.set({
        width: instance.width,
        height: instance.height,
        cropX: instance.left - (instance.width / 2),
        cropY: instance.top - (instance.height / 2),
      });
      bg.requestRenderAll();
    });

    instance.on('moving', (aa) => {
      blurredImage.set({
        width: instance.width,
        height: instance.height,
        cropX: instance.left - (instance.width / 2),
        cropY: instance.top - (instance.height / 2),
      });
      bg.requestRenderAll();


      /*
      blurredImage.left = (blurredImage.width / 2) - x;
      blurredImage.top = (blurredImage.height / 2) - y;
      */

      // blurredImage.left = (blurredImage.width / 2) - x;
      // blurredImage.top = (blurredImage.height / 2) - y;
      /*
      instance2.width = width;
      instance2.height = height;
      instance2.left = x;
      instance2.top = y;
      */

      // blurredImage.top = (blurredImage.height / 2) - instance.height;
    });

});

/*
canvas.setBackgroundImage('http://fabricjs.com/assets/jail_cell_bars.png', canvas.renderAll.bind(canvas), {
    backgroundImageOpacity: 0.5,
    backgroundImageStretch: false
});

canvas.clipTo = function(ctx) {
    ctx.rect(100,100,100,100);
}
*/

</script>
